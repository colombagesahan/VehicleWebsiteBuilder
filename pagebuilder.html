<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DriveHub Visual Page Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --sidebar-w: 360px;
    --primary: #2563eb;
    --bg-dark: #0f1724;
    --bg-light: #ffffff;
    --muted: #64748b;
    --radius: 10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Inter',sans-serif;}
  body{display:flex;background:#111; color:#e6eef6;height:100vh;overflow:hidden;}
  /* SIDEBAR */
  .editor-sidebar{width:var(--sidebar-w);background:#fff;color:#0f1724;display:flex;flex-direction:column;border-right:1px solid rgba(0,0,0,0.08);z-index:20}
  .editor-header{padding:14px 16px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center;background:#f8fafc}
  .back-btn{color:var(--muted);text-decoration:none;font-weight:600}
  .editor-tabs{display:flex;border-bottom:1px solid #f1f5f9}
  .tab-btn{flex:1;padding:12px;border:0;background:transparent;cursor:pointer;font-weight:700;color:var(--muted);font-size:13px}
  .tab-btn.active{color:var(--primary);border-bottom:3px solid var(--primary);background:#eff6ff}
  .editor-content{flex:1;overflow:auto;padding:14px}
  .control-group{margin-bottom:16px}
  .control-group label{display:block;font-size:13px;margin-bottom:6px;font-weight:700;color:#334155}
  .control-group input[type="text"], .control-group textarea, .control-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef6;font-size:14px}
  .small-btn{padding:8px 10px;border-radius:8px;border:0;background:#eef2ff;color:var(--primary);cursor:pointer;font-weight:700}
  .danger-btn{background:#fee2e2;color:#9b1c1c}
  .theme-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .theme-card{border-radius:8px;padding:8px;text-align:center;border:2px solid #f1f5f9;cursor:pointer}
  .theme-card.selected{border-color:var(--primary);background:#eff6ff}
  .editor-footer{padding:12px;border-top:1px solid #f1f5f9;background:#fff}
  .btn-save{width:100%;padding:12px;border-radius:10px;border:0;background:var(--primary);color:white;font-weight:800;cursor:pointer}
  
  /* PREVIEW AREA */
  .preview-area{flex:1;display:flex;align-items:center;justify-content:center;padding:18px;position:relative;background:#0f172a;}
  .preview-frame{width:100%;height:100%;background:white;border-radius:8px;overflow:hidden;border:0;}
  #prevContainer{height:100%;overflow:auto;font-family:'Inter',sans-serif;}
  
  /* PREVIEW STYLES */
  .prev-navbar{padding:20px;display:flex;justify-content:space-between;align-items:center;}
  .prev-hero{padding:60px 20px;text-align:center;}
  .prev-hero h1{font-size:2.5rem;margin-bottom:10px;}
  .prev-section{padding:40px 20px;}
  .section-selected{outline:2px solid var(--primary);position:relative;}
  
  /* Dark Theme Preview Specifics */
  .p-dark { background: #0f172a; color: #cbd5e1; }
  .p-dark .prev-hero { background: rgba(30, 41, 59, 0.5); border-radius: 20px; margin: 20px; }
  .p-dark h1, .p-dark h3 { color: white; }
  .p-dark .card { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 10px; }
</style>
</head>
<body>

  <!-- LOADER -->
  <div id="loader" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:999;background:white">
    <div>Loading Editor...</div>
  </div>

  <aside class="editor-sidebar">
    <div class="editor-header">
      <strong>DriveHub Builder</strong>
      <a class="back-btn" href="index.html">Back to Dash</a>
    </div>

    <div class="editor-tabs">
      <button class="tab-btn active" data-tab="content" onclick="switchTab('content')">Content</button>
      <button class="tab-btn" data-tab="design" onclick="switchTab('design')">Design</button>
    </div>

    <!-- CONTENT TAB -->
    <div id="tab-content" class="editor-content">
      <div class="control-group">
        <label>Business Name</label>
        <input id="bizName" type="text" oninput="updateBizName()">
      </div>

      <div class="control-group">
        <label>Add Section</label>
        <div style="display:flex;gap:8px">
          <select id="addSectionType">
            <option value="hero">Hero Header</option>
            <option value="vehicles">Inventory Grid (Dynamic)</option>
            <option value="about">About Text</option>
            <option value="contact">Contact Info</option>
          </select>
          <button class="small-btn" onclick="addSection()">Add</button>
        </div>
      </div>

      <div id="sectionsList" style="display:flex;flex-direction:column;gap:8px;margin-top:20px;"></div>

      <div id="sectionEditor" style="display:none;border-top:1px solid #eef2ff;padding-top:12px;margin-top:20px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px">
          <strong id="editingTitle">Edit Section</strong>
          <button class="small-btn danger-btn" onclick="removeSection()">Delete</button>
        </div>
        <div id="sectionFields"></div>
        <button class="small-btn mt-2" onclick="applySectionChanges()">Update Preview</button>
      </div>
    </div>

    <!-- DESIGN TAB -->
    <div id="tab-design" class="editor-content" style="display:none">
       <p>Currently locked to DriveHub Dark Theme for best performance.</p>
    </div>

    <div class="editor-footer">
      <button class="btn-save" onclick="saveChanges()">Save & Publish</button>
    </div>
  </aside>

  <main class="preview-area">
    <div class="preview-frame">
        <div id="prevContainer" class="p-dark"></div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey: "AIzaSyBUjzMFao9BS3uXBOW3qYrLVqHaGn8qIk4", authDomain: "onlineshop-30cd1.firebaseapp.com", projectId: "onlineshop-30cd1" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let siteData = { saleName: '', sections: [] };
let currentUser = null;
let editingId = null;

auth.onAuthStateChanged(async user => {
    if(!user) return window.location.href = 'index.html';
    currentUser = user;
    const doc = await db.collection('sites').doc(user.uid).get();
    if(doc.exists) {
        siteData = doc.data();
        if(!siteData.sections) siteData.sections = [];
    } else {
        // Defaults
        siteData.sections = [
            { id: 's1', type: 'hero', visible: true, content: { title: 'Welcome', subtitle: 'Best deals in town', cta: 'View Stock' } },
            { id: 's2', type: 'vehicles', visible: true, content: { title: 'Our Inventory' } }
        ];
    }
    document.getElementById('bizName').value = siteData.saleName || '';
    renderSectionsList();
    renderPreview();
    document.getElementById('loader').style.display = 'none';
});

function switchTab(t) {
    document.querySelectorAll('.editor-content').forEach(e => e.style.display='none');
    document.getElementById('tab-'+t).style.display='block';
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-tab="${t}"]`).classList.add('active');
}

function updateBizName() {
    siteData.saleName = document.getElementById('bizName').value;
    renderPreview();
}

function addSection() {
    const type = document.getElementById('addSectionType').value;
    const id = 's_' + Date.now();
    let content = {};
    if(type === 'hero') content = { title: 'Headline', subtitle: 'Subtitle', cta: 'Button' };
    if(type === 'vehicles') content = { title: 'Latest Arrivals' };
    if(type === 'about') content = { heading: 'About Us', text: 'We are...' };
    if(type === 'contact') content = { phone: '', email: '', address: '' };
    
    siteData.sections.push({ id, type, visible: true, content });
    renderSectionsList();
    renderPreview();
}

function renderSectionsList() {
    const list = document.getElementById('sectionsList');
    list.innerHTML = '';
    siteData.sections.forEach((sec, idx) => {
        list.innerHTML += `<div style="padding:10px; border:1px solid #eee; background:white; cursor:pointer;" onclick="editSection('${sec.id}')">
            <strong>${idx+1}. ${sec.type.toUpperCase()}</strong>
        </div>`;
    });
}

function editSection(id) {
    editingId = id;
    const sec = siteData.sections.find(s => s.id === id);
    document.getElementById('sectionEditor').style.display = 'block';
    const f = document.getElementById('sectionFields');
    f.innerHTML = '';
    
    const c = sec.content;
    if(sec.type === 'hero') {
        f.innerHTML = `<label>Title</label><input id="e_title" value="${c.title}"><label>Sub</label><input id="e_sub" value="${c.subtitle}"><label>Button</label><input id="e_cta" value="${c.cta}">`;
    } else if(sec.type === 'vehicles') {
        f.innerHTML = `<label>Section Title</label><input id="e_vtitle" value="${c.title}"><p style="font-size:0.8rem;color:#666">This section will automatically load your active inventory.</p>`;
    } else if(sec.type === 'about') {
        f.innerHTML = `<label>Heading</label><input id="e_head" value="${c.heading}"><label>Text</label><textarea id="e_text">${c.text}</textarea>`;
    } else if(sec.type === 'contact') {
        f.innerHTML = `<label>Phone</label><input id="e_ph" value="${c.phone||''}"><label>Email</label><input id="e_em" value="${c.email||''}"><label>Address</label><input id="e_ad" value="${c.address||''}">`;
    }
}

function applySectionChanges() {
    const sec = siteData.sections.find(s => s.id === editingId);
    if(sec.type === 'hero') {
        sec.content.title = document.getElementById('e_title').value;
        sec.content.subtitle = document.getElementById('e_sub').value;
        sec.content.cta = document.getElementById('e_cta').value;
    } else if(sec.type === 'vehicles') {
        sec.content.title = document.getElementById('e_vtitle').value;
    } else if(sec.type === 'about') {
        sec.content.heading = document.getElementById('e_head').value;
        sec.content.text = document.getElementById('e_text').value;
    } else if(sec.type === 'contact') {
        sec.content.phone = document.getElementById('e_ph').value;
        sec.content.email = document.getElementById('e_em').value;
        sec.content.address = document.getElementById('e_ad').value;
    }
    renderPreview();
    alert('Preview Updated');
}

function removeSection() {
    siteData.sections = siteData.sections.filter(s => s.id !== editingId);
    document.getElementById('sectionEditor').style.display = 'none';
    renderSectionsList();
    renderPreview();
}

function renderPreview() {
    const con = document.getElementById('prevContainer');
    let html = `<div class="prev-navbar"><h3>${siteData.saleName || 'Brand Name'}</h3><span>Menu</span></div>`;
    
    siteData.sections.forEach(sec => {
        if(sec.type === 'hero') {
            html += `<div class="prev-hero"><h1>${sec.content.title}</h1><p>${sec.content.subtitle}</p><button style="padding:10px 20px; background:#2563eb; color:white; border:none; border-radius:50px;">${sec.content.cta}</button></div>`;
        } else if(sec.type === 'vehicles') {
            html += `<div class="prev-section"><h3>${sec.content.title}</h3><div style="display:grid;grid-template-columns:1fr 1fr; gap:10px;"><div class="card">Vehicle 1</div><div class="card">Vehicle 2</div></div></div>`;
        } else if(sec.type === 'about') {
            html += `<div class="prev-section"><h3>${sec.content.heading}</h3><p>${sec.content.text}</p></div>`;
        } else if(sec.type === 'contact') {
            html += `<div class="prev-section"><h3>Contact</h3><p>${sec.content.phone||'Phone'}</p><p>${sec.content.address||'Address'}</p></div>`;
        }
    });
    con.innerHTML = html;
}

async function saveChanges() {
    const btn = document.querySelector('.btn-save');
    btn.innerText = 'Saving...';
    try {
        await db.collection('sites').doc(currentUser.uid).set(siteData, {merge:true});
        alert('Site Published Successfully!');
    } catch(e) { alert(e.message); }
    btn.innerText = 'Save & Publish';
}
</script>
</body>
</html>
